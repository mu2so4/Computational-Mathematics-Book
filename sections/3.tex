\documentclass[../main.tex]{subfile}

\begin{document}

\section{Численные методы интегрирования}

Как мы находили определённый интеграл от функции $f(x)$ на отрезке $[a,b]$? Мы
всевозможными способами искали первообразную $F(x)$, а затем по формуле
Ньютона-Лейбница $\int_a^bf(x)dx=F(b)-F(a)$ вычисляли его значение. И эта
формула работала.

Проблемы начинаются тогда, когда у функции не получается найти первообразную
или она выглядит слишком сложно или страшно, чтобы в неё что-то там подставлять.
Наконец, функция может быть задана таблично, а не аналитической функцией.

Это значит, что отталкиваться придётся только от исходной функции $f(x)$. О том,
как приближённо найти интеграл без первообразной, и будет рассказано в этой главе.

\begin{define}
	\textbf{Задача численного интегрирования} -- задача нахождения
	определённого интеграла функции без использования её первообразной и
	формулы Ньютона-Лейбница.
\end{define}

Наиболее часто для численного интегрирования используется следующая формула.

\begin{define}\label{eq:quadrature_formula}
	\textbf{Квадратурная формула} -- формула вида
	\[\int_a^bf(x)dx\approx\sum_{k=0}^n c_kf(x_k),\]
	где $c_k$ -- \textbf{весовые коэффициенты}, а $x_k\in[a,b]$ --
	\textbf{узлы интегрирования}.
\end{define}

\begin{define}
	\textbf{Кубатурная формула} -- формула вида
	\[\int_{D}f(x)dx\approx\sum_{k=0}^n c_k f(x_k),\quad x_k\in D,\;D
	\subseteq\mathbb R^m,\;m\ge 2.\]
\end{define}

\begin{define}
	\textbf{Сетка} -- это совокупность узлов $\{x_1,...,x_n\}$ квадратурной
	или кубатурной формулы.
\end{define}

\begin{define}
	\textbf{Погрешность квадратурной формулы} или её \textbf{остаточный
	член} -- это разность
	\[R_{[a,b]}(f)=\int_a^b f(x)dx - \sum_{k=0}^n c_kf(x_k).\]
\end{define}

\begin{define}
	Квадратурная формула называется \textbf{точной} для функции $f$ или
	класса $\mathcal F\ni f$ на интервале $[a,b]$, если верно $R_{[a,b]}(f)=0$.
\end{define}

То, насколько широк класс $\mathcal F$, на которых квадратурная формула точна,
может говорить о точности квадратурной формулы в целом. Часто в качестве класса
''пробных'' функций $\mathcal F$ берут алгебраические полиномы.

\begin{define}\label{eq:algebraic_degree_of_accuracy}
	\textbf{Алгебраическая степень точности} квадратурной формулы --
	наибольшая степень алгебраического полинома, для которого эта формула
	точна на всей вещественной оси.
\end{define}

Конечно, для нас предпочтительней формулы с б\'{о}льшей алгебраической степенью
точности.

\subsection{Формулы Ньютона-Котеса}
Простейший приём построения квадратурных формул -- замена подынтегральной
функции $f(x)$ на интервале интегрирования $[a,b]$ на ''более простую'',
легче интегрируемую функцию. Подынтегральную функцию чаще всего интерполируют
алгебраическими полиномами.\newpage

\begin{define}
	\textbf{Интерполяционная квадратурная формула} -- квадратурная формула
	\eqref{eq:quadrature_formula}, которая заменяет исходную функцию $f(x)$
	интерполянтом по простым (то есть не кратным) узлам $\{x_1,...,x_n\}$:
	\[f(x)\approx g(x)=\sum_{k=0}^{n}f(x_k)\gamma_k(x),\]
	где $\gamma_k(x)$ -- некоторые функции. Тогда интеграл приблизительно
	равен
	\[\int_{a}^{b}f(x)dx\approx\sum_{k=0}^{n}f(x_k)
	\underset{c_k}{\underbrace{\int_{a}^{b}\gamma_k(x)dx}}.\]
\end{define}

\begin{define}\label{eq:newton_cotes_formula}
	\textbf{Формула Ньютона-Котеса} -- интерполяционная квадратурная
	формула, полученная с помощью алгебраической интерполяции
	\eqref{eq:interpolating_polynomial} подынтегральной функции на
	равномерной сетке с простыми узлами на отрезке $[a,b]$.
\end{define}

\begin{define}
	\begin{itemize}[nosep, before = \leavevmode\vspace{-\baselineskip}]
		\item Формула Ньютона-Котеса \textbf{замкнутого типа},
			если оба предела интегрирования являются узлами
			интерполяции.
		\item Формула Ньютона-Котеса \textbf{открытого типа},
			если она не замкнутого типа.
	\end{itemize}
\end{define}

\subsection{Формулы прямоугольников}
Очевидно, что простейшая квадратурная формула -- это просто взять константу.

\begin{define}\label{eq:rectangle_rule}
	\textbf{Формула прямоугольников} -- квадратурная формула Ньютона-Котеса
	открытого типа, интерполяционная функция которой задаётся единственным
	узлом $x_0\in[a,b]$ и, следовательно, равна константе. Формула имеет вид
	\[\boxed{\int_{a}^{b}f(x)dx\approx f(x_0)(b-a)}\]
\end{define}

Название идёт из того, что она совпадает с площадью прямоугольника со сторонами
$(b-a)$ и $f(x_0)$. Не нужно забывать, что геометрический смысл интеграла -- это
площадь фигуры под графиком функции.

\begin{define}
	Если в формуле \eqref{eq:rectangle_rule} $x_0$ такой, что
	\begin{itemize}[noitemsep, nolistsep]
		\item $x_0=a$, это \textbf{формула левого прямоугольника}.
		\item $x_0=b$, это \textbf{формула правого прямоугольника}.
		\item $x_0=\frac{a+b}{2}$, это \textbf{формула среднего
			прямоугольника}.
	\end{itemize}
	\subfile{graphs/3.2-rectangle-rules}

\end{define}

\begin{theorem}[об оценке погрешности формулы средних прямоугольников]
\label{eq:middle_rectangle_rule_error}
	Погрешность формулы средних прямоугольников для интеграла $\int_a^b
	f(x)dx$ может быть оценена следующим неравенством:
	\[\boxed{|R_{[a,b]}(f)|\le\frac{M_2h^3}{24}},\]
	где $h=b-a$, $M_i=\underset{x\in[a,b]}{max}|f^{(i)}(x)|.$
\end{theorem}

\begin{proof}
	Разложим функцию $f(x)$ в ряд Тейлора:
	\[f(x)=f(c)+f'(c)(x-c)+\frac{f''(\xi)(x-c)^2}{2},\]
	где $c=\frac{a+b}{2},\;\xi\in[a,b].$ Погрешность квадратурной формулы
	равна:
	\[R_{[a,b]}(f)=\int_a^b f(x)dx - f(c)(b-a)=\int_a^b\big(f(x) - f(c)\big)
	dx=\]
	\[=\int_a^b \Big(\cancel{f'(c)(x-c)}+\frac{f''(\xi)(x-c)^2}{2}\Big)dx=
	\frac{f''(\xi)(x-c)^3}{6}\Big|_a^b=\]
	\[=\frac{f''(\xi)}{6}\Big((b-c)^3-(a-c)^3\Big)=\frac{f''(\xi)}{6}2\Big(
	\frac{h}{2}\Big)^3=\frac{f''(\xi)h^3}{24}.\]

	Теперь оценка очевидна:
	\[|R_{[a,b]}(f)|=\Big|\frac{f''(\xi)h^3}{24}\Big|\le\frac{M_2h^3}{24}.\]
\end{proof}

Оценка неулучшаема, поскольку она достигается для интеграла\\
$\int_a^b(x-\frac{1}{2}(a+b))^2dx$.

\begin{theorem}
	Погрешность формулы правых и левых прямоугольников для интеграла
	$\int_a^b f(x)dx$ может быть оценена следующим неравенством:
	\[\boxed{|R_{[a,b]}(f)|\le\frac{M_1h^2}{2}}\]
\end{theorem}

\begin{proof}
	Для определённости будем считать, что мы ищем погрешность для формулы
	левых прямоугольников. Разложив функцию $f(x)$ в ряд Тейлора только до
	первой производной и проделав тот же путь, что и в
	\eqref{eq:middle_rectangle_rule_error}, получим следующее:
	\[|R_{[a,b]}(f)|=\Big|\;\frac{f'(\xi)(x-a)^2}{2}\Big|_a^b\;\Big|=
	\Big|\frac{f'(\xi)h^2}{2}\Big|\le\frac{M_1h^2}{2}\]
\end{proof}

\subsection{Формула трапеций}
На пути у нас формула Ньютона-Котеса первой степени, то есть $n=1$.

\begin{define}
	\textbf{Формула трапеций} -- квадратурная формула Ньютона-Котеса
	замкнутого типа \eqref{eq:newton_cotes_formula}, интерполяционная
	функция которой задаётся двумя узлами и, следовательно, является
	уравнением прямой.
\end{define}

\begin{theorem}[формула трапеций]\label{eq:trapezoidal_rule}
	Формула трапеций для интеграла $\int_a^b f(x)dx$ имеет
	вид
	\[\boxed{\int_a^b f(x)dx\approx\frac{b-a}{2}\big(f(a)+f(b)\big)}\]
\end{theorem}

\begin{proof}
	Представим интерполяционный полином квадратурной формулы в форме
	Лагранжа \eqref{eq:lagrange_polynomial}:
	\[P_1(x)=\frac{x-b}{a-b}f(a)+\frac{x-a}{b-a}f(b).\]
	Проинтегрировав это равенство, получим:
	\[\int_a^b P_1(x)dx=\frac{f(a)}{a-b}\int_a^b (x-b)dx +
	\frac{f(b)}{b-a}\int_a^b (x-a)dx=\]
	\[=\frac{f(a)}{a-b}\frac{(x-b)^2}{2}\Big|_a^b+\frac{f(b)}{b-a}
	\frac{(x-a)^2}{2}\Big|_a^b=\frac{b-a}{2}\big(f(a)+f(b)\big).\]
\end{proof}

Так же, как и формулы прямоугольников, формула трапеций получила своё название
благодаря тому, что графически это площадь трапеции:
\subfile{graphs/3.3-trapezoidal-rule-compared}

\begin{theorem}[об оценке погрешности формулы трапеций]
\label{eq:trapezoidal_rule_error}
	Погрешность формулы трапеций для интеграла $\int_a^b f(x)dx$ может быть
	оценена следующим неравенством:
	\[\boxed{|R_{[a,b]}(f)|\le\frac{M_2h^3}{12}},\]
	где $h=b-a$, $M_2=\underset{x\in[a,b]}{max}|f^{(2)}(x)|.$
\end{theorem}

\begin{proof}
	Для оценки погрешности вспомним значение погрешности интерполяционного
	полинома \eqref{eq:interpolation_der_error_form}:
	\[f(x)-P_1(x)=\frac{f''(\xi)}{2}(x-a)(x-b),\]
	где $\xi=\xi(x)\in[a,b]$. От погрешности интерполяции перейдём к
	погрешности интеграла:
	\[R(f)=\int_a^b\frac{f''(\xi)}{2}(x-a)(x-b)dx=\frac{f''(\xi)}{2}\int_a^b
	(x-a)(x-b)dx.\]
	$\big|\frac{f''(\xi)}{2}\big|\le\big|\frac{M_2}{2}\big|$, интеграл же
	посчитаем:
	\[\int_a^b(x-a)(x-b)dx=\frac{x^3}{3}\;\Big|_a^b-(a+b)\frac{x^2}{2}\;
	\Big|_a^b+abx\;\Big|_a^b=\]
	\[=\frac{h}{6}\Big(2(a^2+ab+b^2)-3(a^2+2ab+b^2)+6ab\Big)=-\frac{h^3}{6}.
	\]
	Окончательно имеем
	\[|R_{[a,b]}(f)|\le\frac{M_2h^3}{12}.\]
\end{proof}

Эта оценка также неулучшаема: она достигается для интеграла\\
$\int_a^b (a+b)^2dx$.

\subsection{Формула парабол (Симпсона)}
После полинома первой степени (прямой) идёт полином степени второй, или же
парабола.

\begin{define}
	\textbf{Формула парабол} или \textbf{Формула Симпсона} -- квадратурная
	формула Ньютона-Котеса \eqref{eq:newton_cotes_formula} замкнутого типа,
	интерполяционная функция которой задаётся тремя узлами: граничными и
	серединным, -- и, следовательно, является уравнением параболы.
\end{define}

\begin{theorem}[формула Симпсона]\label{eq:simpsons_1_3_rule}
	Формула Симпсона для интеграла $\int_a^b f(x)dx$ имеет вид
	\[\boxed{\int_a^b f(x)dx\approx\frac{b-a}{6}\Big(f(a)+4f\big(\frac{a+b}
	{2}\big)+f(b)\Big)}\]
\end{theorem}

\begin{proof}
	Обозначим $c=\frac{a+b}{2}$, $h=b-a$. Представим интерполяционный полином
	в форме Ньютона
	\eqref{eq:newton_polynomial}:
	\[P_2(x)=P_1(x)+f[a,b,c](x-a)(x-b).\]
	Из \eqref{eq:trapezoidal_rule} и из доказательства
	\eqref{eq:trapezoidal_rule_error}
	\[\int_a^b P_1(x)dx=\frac{h}{2}\big(f(a)+f(b)\big),\quad\int_a^b (x-a)
	(x-b)dx=-\frac{h^3}{6}.\]
	Посчитаем разделённые разности:
	\[f[a,b]=\frac{f(b)-f(a)}{b-a}=\frac{f(b)-f(a)}{h},\]
	\[f[b,c]=\frac{f(c)-f(b)}{c-b}=2\cdot\frac{f(b)-f(c)}{h},\]
	\[f[a,b,c]=\frac{2\cdot\frac{f(b)-f(c)}{h}-\frac{f(b)-f(a)}{h}}{h/2}=
	\frac{2}{h^2}\big(f(a)-2f(c)+f(b)\big).\]
	Окончательно получаем:
	\[\int_a^b P_2(x)dx=\frac{h}{2}\big(f(a)+f(b)\big)-\frac{h^{\cancel{3}}}
	{6}\frac{2}{\cancel{h^2}}\big(f(a)-2f(c)+f(b)\big)=\]
	\[=\frac{h}{6}\big(f(a)+4f(c)+f(b)\big).\]
\end{proof}

Однако данное доказательство нашёл я. У С. П. Шарого и на лекции было совсем
другое доказательство. Приведём и его.

\begin{proof}
	Задача -- построить параболу $P_2(x)$ по трём точкам $(a,f(a))$,
	$\big(\frac{a+b}{2},f(\frac{a+b}{2})\big)$ и $(b,f(b))$. Для упрощения
	расчётов произведём параллельный перенос криволинейной трапеции, площадь
	которой мы и пытаемся найти, так, чтобы точка $a$ совпала с осью
	абсцисс -- отрезок интегрирования перейдёт в $[0,b-a]$. Обозначим
	$h=b-a$ и $m=\frac{a+b}{2}$.

	Пусть $P_2^*(x)=c_1+c_2x+c_3x^2$ -- полином второй степени, являющийся
	интерполянтом сдвинутой функции $f(x+a)=g(x)$. Соответственно, полином
	$P_2^*(x)$ проходит через точки $(0,g(0))$, $\big(\frac{h}{2},
	g(\frac{h}{2})\big)$ и $(h,g(h))$. Составим систему уравнений:
	\begin{equation*}
		\begin{cases}
			c_1 = f(a), \\
			c_1 + \mathlarger{\frac{h}{2}}c_2 + \mathlarger{\frac
				{h^2}{4}}c_3 = f(m), \\
			c_1 + h c_2 + h^2 c_3 = f(b). \\
		\end{cases}
	\end{equation*}

	Интеграл равен
	\[\int_a^b P_2(x)dx=\int_0^h P_2^*(x)dx=\Big(c_1x+\frac{c_2x^2}{2}+
	\frac{c_3x^3}{3}\Big)\Big|_0^h=\]
	\[\frac{h}{6}(6c_1+3c_2h+2c_3h^2).\]
	Решать систему выше необязательно, так как полученный трёхчлен легко
	выражается через уравнения системы: домжожим второе уравнение на 4,
	сложим его с первым и третьим и получим:
	\[\int_a^b P_2(x)dx=\frac{h}{6}\big(f(a)+4f(m)+f(b)\big).\]
\end{proof}

\subfile{graphs/3.4-simpsons-1_3-rule-compared}

\begin{lemma}
	Алгебраическая степень точности \eqref{eq:algebraic_degree_of_accuracy}
	формулы Симпсона \eqref{eq:simpsons_1_3_rule} равна трём.
\end{lemma}

\begin{proof}
	Точность формулы Симпсона для полиномов степени, не большей 2, следует
	из построения интерполяционного полинома, чья степень равна 2. Теперь
	проверим её точность для третьей степени на мономе $x^3$:
	\[\int_a^b x^3dx=\frac{b^4-a^4}{4}.\]
	Теперь найдём приближённо интеграл формулой Симпсона:
	\[\int_a^b P_2(x)dx=\frac{b-a}{6}\Big(a^3+\frac{(a+b)^3}{2}+b^3\Big)=\]
	\[\frac{b-a}{\cancel{12}\;4}(\cancel{3}a^3+\cancel{3}a^2b+\cancel{3}ab^2
	+\cancel{3}b^3)=\frac{b^4-a^4}{4}=\int_a^b x^3dx.\]

	После того как мы доказали точность формулы для третьей степени, докажем
	её неточность для четвёртой на мономе $x^4$:
	\[\int_a^b x^4dx=\frac{b^5-a^5}{5},\]
	а по формуле
	\[\int_a^b P_2(x)dx=\frac{b-a}{6}\Big(a^4+\frac{(a+b)^4}{4}+b^4\Big)=\]
	\[=\frac{b-a}{24}(5a^4+4a^3b+6a^2b^2+4ab^3+5b^4)\ne\frac{b^5-a^5}{5}.\]
\end{proof}

\begin{theorem}[оценка погрешности формулы Симпсона]
	Погрешность формулы Симпсона для интеграла $\int_a^b f(x)dx$ может быть
	оценена следующим неравенством:
	\[\boxed{|R(f)|\le\frac{M_4|h|^5}{2880}},\]
	где $h=b-a$, $M_4=\underset{x\in[a,b]}{max}|f^{(4)}(x)|.$
\end{theorem}

\begin{proof}
	В предыдущей лемме мы установили, что алгебраическая точность формулы
	Симпсона выше степени интерполяционного полинома, который интерполирует
	подынтегральное выражение. Значит, для оценки погрешности следует
	использовать интерполяционный полином третьей степени, что при начичии
	всего трёх узлов интерполяции означает повторное использование
	имеющихся. Пусть мы повторно взяли серединный узел $c=\frac{a+b}{2}$.
	Тогда по оценке \eqref{eq:interpolation_der_error_form}
	\[f(x)-P_3(x)=\frac{f^{(4)}(\xi)}{24}(x-a)(x-c)^2(x-b).\]
	Посчитаем значение нашего интеграла:
	\[\int_a^b (x-a)(x-c)^2(x-b)dx=
		\begin{bmatrix}
			t=x-c,	& a'=a-c=-h/2 \\
			x=t+c,	& b'=b-c=h/2\\
		\end{bmatrix}
		=
	\]
	\[=\int_{-h/2}^{h/2}\Big(t+\frac{h}{2}\Big)t^2\Big(t-\frac{h}{2}\Big)dt=
	2\int_0^{h/2}t^2\Big(t^2-\frac{h^2}{4}\Big)dt=\]
	\[=2\Big(\frac{t^5}{5}-\frac{h^2t^3}{12}\Big)\;\Big|_0^{h/2}=
	-\frac{h^5}{120}.\]
	Окончательно получаем
	\[\Big|\frac{f^{(4)}(\xi)}{24}\Big|\le\frac{M_4}{24},\;\int_a^b\omega(x)
	dx=-\frac{h^5}{120}\quad\Rightarrow\quad|R(f)|\le\frac{M_4|h|^5}{2880}.\]
\end{proof}

\subsection{Формула трёх восьмых}
Коротко представим квадратурную формулу, которая использует полиномы третьей
степени для интерполяции подынтегральной функции.

\begin{define}
	\textbf{Формула трёх восьмых} -- квадратурная формула Ньютона-Котеса
	\eqref{eq:newton_cotes_formula} замкнутого типа, интерполяционная
	функция которой задаётся четырьмя узлами и, следовательно, является
	уравнением кубической параболы.
\end{define}

\begin{theorem}[формула трёх восьмых]\label{eq:simpsons_3_8_rule}
	Формула трёх восьмых для интеграла $\int_a^b f(x)dx$ имеет вид
	\[\boxed{\int_a^b f(x)dx\approx\frac{3h}{8}\big(f(a)+3f(a+h)+3f(b-h)+
	f(b)\big)},\]
	где $3h=b-a$.
\end{theorem}
\proofexercise

\subfile{graphs/3.5-simpsons-3_8-rule-compared}

\begin{lemma}
	Алгебраическая степень точности \eqref{eq:algebraic_degree_of_accuracy}
	формулы трёх восьмых равна трём.
\end{lemma}
\proofexercise

\begin{theorem}[оценка погрешности формулы трёх восьмых]
	Погрешность формулы трёх восьмых для интеграла $\int_a^b f(x)dx$ может
	быть оценена следующим неравенством:
	\[\boxed{|R(f)|\le\frac{M_4|b-a|^5}{6480}}\]
\end{theorem}
\proofexercise\newpage

\subsection{Составные квадратурные формулы}
Всё, что мы сейчас рассмотрели, были так называемые простые квадратурные
формулы, то есть мы их применяли сразу ко всему отрезку интегрирования. Однако
погрешность таких формул резко возрастает с ростом длины отрезка интегрирования.
Чтобы уменьшить её, мы можем применить полученные формулы не ко всему отрезку
интегрирования сразу, а на его отдельных частях, не забыв затем сложить
полученные результаты.

\begin{define}
	\textbf{Простая квадратурная формула} -- квадратурная формула
	\eqref{eq:quadrature_formula}, которая применяется ко всему отрезку
	интегрирования $[a,b]$.
\end{define}

\begin{define}
	\textbf{Разбиение отрезка} $[a,b]$ на $N$ частей -- совокупность
	отрезков $[x_k,x_{k+1}]$ такая, что $k\in\{0,1,...,n\},\;x_0=a,\;x_{N+1}
	=b,\;x_i<x_j\;\text{при}\;i<j$. Получившиеся отрезки называются
	\textbf{элементарными}.
\end{define}

\begin{define}
	\textbf{Отрезок частичного интегрирования} -- часть основного отрезка,
	на котором производится интегрирование. Он может включать в себя один
	или несколько \underline{последовательных} элементарных отрезков.
\end{define}

\begin{define}
	\textbf{Составная квадратурная формула} с разбиением на $N$ отрезков --
	квадратурная формула \eqref{eq:quadrature_formula}, которая применяет
	простую квадратурную формулу на каждом из $N$ равных по длине, попарно
	неперекрывающихся и покрывающих весь отрезок интегрирования $[a,b]$
	отрезков частичного интегрирования.
\end{define}
\newpage

\begin{theorem}[составная формула средних прямоугольников]
	\textbf{Составная формула средних прямоугольников} с разбиением на $N$
	отрезков имеет вид
	\[\boxed{\int_a^b f(x)dx\approx h\sum_{i=1}^{N}f\Big(\frac{x_{i-1}+x_i}
	{2}\Big),\quad h=\frac{b-a}{N}}\]
\end{theorem}

\begin{proof}
	Формула легко выводится из простой формулы \\
	\eqref{eq:rectangle_rule} со сложением частичных результатов.
\end{proof}

\begin{theorem}[составная формула трапеций]
	\textbf{Составная формула трапеций} с разбиением на $N$ отрезков имеет вид
	\[\boxed{\int_a^b f(x)dx\approx \frac{h}{2}\Big(f(a)+2\sum_{i=1}^{N-1}
	f(x_i)+f(b)\Big),\quad h=\frac{b-a}{N}}\]
\end{theorem}

\begin{proof}
	Формула выводится из \eqref{eq:trapezoidal_rule} так же, как и
	предыдущая.
\end{proof}

\begin{theorem}[составная формула Симпсона]
	\textbf{Составная формула Симпсона} с разбиением на $N$ отрезков имеет вид
	\[\boxed{\int_a^b f(x)dx\approx \frac{h}{6}\Big(f(a)+2\sum_{i=1}^{N-1}
	f(x_{2i})+4\sum_{j=1}^{N}f(x_{2j-1})+f(b)\Big),\quad h=\frac{b-a}{N}}\]
\end{theorem}

\begin{proof}
	Аналогично предыдущим формулам из \eqref{eq:simpsons_1_3_rule}.
\end{proof}

\begin{remark}
	Составная формула Симпсона с разбиением на $N$ отрезков использует $2N$
	равных по длине элементарных отрезка разбиения.
\end{remark}
\newpage

\begin{theorem}[составная формула трёх восьмых]
	\textbf{Составная формула трёх восьмых} с разбиением на $N$ отрезков
	имеет вид
	\[\boxed{\int_a^b f(x)dx\approx \frac{h}{8}\Big(f(a)+2\sum_{i=1}^{N-1}
	f(x_{3i})+3\sum_{j=1}^{N}f(x_{3j-1}+x_{3j-2})+f(b)\Big)}\]
	\[\quad h=\frac{b-a}{N}\]
\end{theorem}

\begin{proof}
	Аналогично предыдущим формулам из \eqref{eq:simpsons_3_8_rule}.
\end{proof}

\begin{remark}
	Составная формула трёх восьмых с разбиением на $N$ отрезков использует
	$3N$
	равных по длине элементарных отрезка разбиения.
\end{remark}

\begin{figure}[ht]
	\tikzset{declare function={
		f(\x)= cos(\x / pi * 180)+sqrt(\x);
	}}
	\centering
	\newcommand*{\varA}{2}
	\newcommand*{\varB}{14}
	\newcommand*{\Height}{7.5cm}
	\newcommand*{\Width}{8cm}
	\pgfmathsetmacro{\fa}{f(\varA)}
	\pgfmathsetmacro{\fb}{f(\varB)}
	\pgfmathsetmacro{\leftDomain}{\varA-0.5}
	\pgfmathsetmacro{\rightDomain}{\varB+1.1}
	\pgfmathsetmacro{\yMin}{-0.9}
	\pgfmathsetmacro{\yMax}{5}
	\pgfmathsetmacro{\varC}{(\varA+\varB)/2}
	\pgfmathsetmacro{\fc}{f(\varC)}

	\begin{tikzpicture} [
		declare function = {
			linear(\x,\a,\b) = (\x-\b)*f(\a)/(\a-\b);
			up(\x,\a,\b)= linear(\x,\a,\b) +
				linear(\x,\b,\a);
		},]

		\begin{axis} [
			height=\Height,
			width=\Width,
			xlabel = {$x$},
			ylabel = {$y$},
			axis x line = middle,
			axis y line = middle,
			ymin = \yMin,
			ymax = \yMax,
			domain = \leftDomain:\rightDomain,
			set layers=standard,
			ticks = none ]

			\newcommand*{\divCount}{6}
			\pgfmathsetmacro{\divCou}{\divCount-1}
			\pgfmathsetmacro{\Step}{(\varB-\varA)/\divCount}

			\addplot[color=blue, line width=.08cm]{f(x)};
			\pgfplotsinvokeforeach{0,...,\divCou} {
				\pgfmathsetmacro{\xx}{\varA + #1 * \Step}
				\pgfmathsetmacro{\xF}{\xx+\Step}
				\pgfmathsetmacro{\y}{f(\xx+\Step/2)}
				\addplot[color=black, thick]
					coordinates {(\xx, 0) (\xx, \y)};
				\addplot[color=black, thick]
					coordinates {(\xF, 0) (\xF, \y)};
				\addplot[draw=none, domain=\xx:\xF, name path=B]
					{0};
				\addplot[color=black, thick, domain=\xx:\xF,
					name path=A] {f(\xx+\Step/2)};
				\tikzfillbetween[of=A and B]{gray, opacity=0.5};
			}

			\coordinate(A) at 	(\varA,		\fa);
			\coordinate(Ap) at 	(\varA,		0);
			\coordinate(B) at 	(\varB,		\fb);
			\coordinate(Bp) at 	(\varB,		0);

			\node[below](Alb) at 	(\varA,		0) {$a$};
			\node[below](Blb) at 	(\varB,		0) {$b$};

			\addplot[mark=*,only marks, fill=black] (\varA, 0)
				node[above, pos=1]{};
			\addplot[mark=*,only marks, fill=black] (\varB, 0)
				node[above, pos=1]{};

			%\draw[thick] (Bp) -- (B);

		\end{axis}
	\end{tikzpicture}\qquad
	\begin{tikzpicture} [
		declare function = {
			linear(\x,\a,\b) = (\x-\b)*f(\a)/(\a-\b);
			up(\x,\a,\b)= linear(\x,\a,\b) +
				linear(\x,\b,\a);
		},]

		\begin{axis} [
			height=\Height,
			width=\Width,
			xlabel = {$x$},
			ylabel = {$y$},
			axis x line = middle,
			axis y line = middle,
			ymin = \yMin,
			ymax = \yMax,
			domain = \leftDomain:\rightDomain,
			set layers=standard,
			ticks = none ]

			\newcommand*{\divCount}{6}
			\pgfmathsetmacro{\divCou}{\divCount-1}
			\pgfmathsetmacro{\Step}{(\varB-\varA)/\divCount}

			\addplot[color=blue, line width=.08cm]{f(x)};
			\addplot[draw=none,name path=B] {0};
			\pgfplotsinvokeforeach{0,...,\divCou} {
				\pgfmathsetmacro{\xx}{\varA + #1 * \Step}
				\pgfmathsetmacro{\xF}{\xx+\Step}
				\pgfmathsetmacro{\y}{f(\xx)}
				\pgfmathsetmacro{\yF}{f(\xF)}
				\addplot[color=black, thick]
					coordinates {(\xx, 0) (\xx, \y)};
				\addplot[draw=none, domain=\xx:\xF, name path=B]
					{0};
				\addplot[color=black, thick, domain=\xx:\xF,
					name path=A] {up(x,\xx,\xF)};
				\tikzfillbetween[of=A and B]{gray, opacity=0.5};
			}

			\coordinate(A) at 	(\varA,		\fa);
			\coordinate(Ap) at 	(\varA,		0);
			\coordinate(B) at 	(\varB,		\fb);
			\coordinate(Bp) at 	(\varB,		0);

			\node[below](Alb) at 	(\varA,		0) {$a$};
			\node[below](Blb) at 	(\varB,		0) {$b$};

			\addplot[mark=*,only marks, fill=black] (\varA, 0)
				node[above, pos=1]{};
			\addplot[mark=*,only marks, fill=black] (\varB, 0)
				node[above, pos=1]{};

			\draw[thick] (Bp) -- (B);

		\end{axis}
	\end{tikzpicture}

	\begin{tikzpicture} [
		declare function = {
			subpolynonominal(\x,\A,\b,\c) = (\x-\b)*(\x-\c) /
				((\A-\b)*(\A-\c)) * f(\A);
			lag(\x,\a,\b,\c) =
				subpolynonominal(\x,\a,\b,\c) +
				subpolynonominal(\x,\b,\c,\a) +
				subpolynonominal(\x,\c,\a,\b);
		},]

		\begin{axis} [
			height=\Height,
			width=\Width,
			xlabel = {$x$},
			ylabel = {$y$},
			axis x line = middle,
			axis y line = middle,
			ymin = \yMin,
			ymax = \yMax,
			domain = \leftDomain:\rightDomain,
			set layers=standard,
			ticks = none ]

			\newcommand*{\divCount}{3}
			\pgfmathsetmacro{\divCou}{\divCount-1}
			\pgfmathsetmacro{\Step}{(\varB-\varA)/\divCount}

			\addplot[color=blue, line width=.08cm]{f(x)};
			\addplot[draw=none,name path=B] {0};
			\pgfplotsinvokeforeach{0,...,\divCou} {
				\pgfmathsetmacro{\xx}{\varA + #1 * \Step}
				\pgfmathsetmacro{\xF}{\xx+\Step/2}
				\pgfmathsetmacro{\xS}{\xx+\Step}
				\pgfmathsetmacro{\y}{f(\xx)}
				\pgfmathsetmacro{\yF}{f(\xF)}
				\addplot[draw=none, domain=\xx:\xS, name path=B]
					{0};
				\addplot[color=black, thick]
					coordinates {(\xx, 0) (\xx, \y)};
				\addplot[color=black, thick,dashed]
					coordinates {(\xF, 0) (\xF, \yF)};
				\addplot[color=black, thick, domain=\xx:\xS,
					name path=A] {lag(x,\xx,\xF,\xS)};
				\tikzfillbetween[of=A and B]{gray, opacity=0.5};
			}

			\coordinate(A) at 	(\varA,		\fa);
			\coordinate(Ap) at 	(\varA,		0);
			\coordinate(B) at 	(\varB,		\fb);
			\coordinate(Bp) at 	(\varB,		0);

			\node[below](Alb) at 	(\varA,		0) {$a$};
			\node[below](Blb) at 	(\varB,		0) {$b$};

			\addplot[mark=*,only marks, fill=black] (\varA, 0)
				node[above, pos=1]{};
			\addplot[mark=*,only marks, fill=black] (\varB, 0)
				node[above, pos=1]{};

			\draw[thick] (Bp) -- (B);

		\end{axis}
	\end{tikzpicture}\qquad
	\begin{tikzpicture} [
		declare function = {
			divDiff1(\a,\b) = (f(\b)-f(\a)) / (\b-\a);
			divDiff2(\a,\b,\c) = (divDiff1(\b,\c)-divDiff1(\a,\b)) /
				(\c-\a);
			divDiff3(\a,\b,\c,\d) = (divDiff2(\b,\c,\d) -
				divDiff2(\a,\b,\c)) / (\d-\a);
			newton(\x,\a,\b,\c,\d)= f(\a) + divDiff1(\a,\b)*(\x-\a)+
				divDiff2(\a,\b,\c)*(\x-\a)*(\x-\b) +
				divDiff3(\a,\b,\c,\d)*(\x-\a)*(\x-\b)*(\x-\c);
		},]

		\begin{axis} [
			height=\Height,
			width=\Width,
			xlabel = {$x$},
			ylabel = {$y$},
			axis x line = middle,
			axis y line = middle,
			ymin = \yMin,
			ymax = \yMax,
			domain = \leftDomain:\rightDomain,
			set layers=standard,
			ticks = none ]

			\newcommand*{\divCount}{2}
			\pgfmathsetmacro{\divCou}{\divCount-1}
			\pgfmathsetmacro{\Step}{(\varB-\varA)/\divCount}

			\addplot[color=blue, line width=.08cm]{f(x)};
			\addplot[draw=none,name path=B] {0};
			\pgfplotsinvokeforeach{0,...,\divCou} {
				\pgfmathsetmacro{\xx}{\varA + #1 * \Step}
				\pgfmathsetmacro{\xF}{\xx+\Step/3}
				\pgfmathsetmacro{\xS}{\xx+\Step*2/3}
				\pgfmathsetmacro{\xT}{\xx+\Step}
				\pgfmathsetmacro{\y}{f(\xx)}
				\pgfmathsetmacro{\yF}{f(\xF)}
				\pgfmathsetmacro{\yS}{f(\xS)}
				\addplot[draw=none, domain=\xx:\xT, name path=B]
					{0};
				\addplot[color=black, thick]
					coordinates {(\xx, 0) (\xx, \y)};
				\addplot[color=black, thick,dashed]
					coordinates {(\xF, 0) (\xF, \yF)};
				\addplot[color=black, thick,dashed]
					coordinates {(\xS, 0) (\xS, \yS)};
				\addplot[color=black, thick, domain=\xx:\xT,
					name path=A] {newton(x,\xx,\xF,\xS,\xT)};
				\tikzfillbetween[of=A and B]{gray, opacity=0.5};
			}

			\coordinate(A) at 	(\varA,		\fa);
			\coordinate(Ap) at 	(\varA,		0);
			\coordinate(B) at 	(\varB,		\fb);
			\coordinate(Bp) at 	(\varB,		0);

			\node[below](Alb) at 	(\varA,		0) {$a$};
			\node[below](Blb) at 	(\varB,		0) {$b$};

			\addplot[mark=*,only marks, fill=black] (\varA, 0)
				node[above, pos=1]{};
			\addplot[mark=*,only marks, fill=black] (\varB, 0)
				node[above, pos=1]{};

			\draw[thick] (Bp) -- (B);

		\end{axis}
	\end{tikzpicture}
	\caption*{Составные формулы в сравнении}
\end{figure}

\end{document}
